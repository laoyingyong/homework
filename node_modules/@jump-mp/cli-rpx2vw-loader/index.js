const loaderUtils = require('loader-utils')
var assign = require('object-assign');

function toFixed(number, precision) {
  var multiplier = Math.pow(10, precision + 1),
      wholeNumber = Math.floor(number * multiplier);
  return Math.round(wholeNumber / 10) * 10 / multiplier;
}

module.exports = function(source) {
  let opts = loaderUtils.getOptions(this) || {}
  opts = assign({
    unit: 'rpx',
    width: 750,
    ratio: 1,
    unitPrecision: 6,
    targetUnits: 'vw',
  }, opts);

  source.replace(/\b(\d+(\.\d+)?)rpx\b/ig, function (match, x) {
    const scale = 100 / opts.width;
    const newVal = toFixed(x * opts.ratio * scale, opts.unitPrecision) + 'vw'
    source = source.replace(match,newVal)
  });
  return source;

}